CREATE PROC [dbo].[SP_INDANHSACHMUONSACH]
@MADOCGIA INT
AS
BEGIN
	IF EXISTS (SELECT 1 FROM dbo.DOCGIA AS dg WHERE dg.MADOCGIA = @MADOCGIA AND dg.HOATDONG = 1)
		BEGIN

			SELECT MAPM, pm.NGAYMUON INTO #PhieuMuonTemp FROM dbo.PHIEUMUON AS pm WHERE pm.MADOCGIA = @MADOCGIA

			SELECT MASACH, pmt.NGAYMUON INTO #PhieuMuonTemp1 FROM #PhieuMuonTemp AS pmt 
			INNER JOIN dbo.CT_PHIEUMUON
			ON CT_PHIEUMUON.MAPM = pmt.MAPM

			SELECT pmt1.MASACH, dbo.DAUSACH.TENSACH, pmt1.NGAYMUON FROM #PhieuMuonTemp1 AS pmt1
			INNER JOIN dbo.SACH
			ON SACH.MASACH = pmt1.MASACH
			INNER JOIN dbo.DAUSACH
			ON DAUSACH.ISBN = SACH.ISBN
		END 
	ELSE
		BEGIN
			RETURN -1
		END
END

CREATE PROC [dbo].[SP_THONGKESACHMUONSACH]
AS
BEGIN
		SELECT MAPM, pm.NGAYMUON INTO #PhieuMuonTemp FROM dbo.PHIEUMUON AS pm

		SELECT MASACH, pmt.NGAYMUON INTO #PhieuMuonTemp1 FROM #PhieuMuonTemp AS pmt 
		INNER JOIN dbo.CT_PHIEUMUON AS ctpm
		ON ctpm.MAPM = pmt.MAPM

		SELECT TOP(10) ds.ISBN, ds.TENSACH, COUNT(pmt1.NGAYMUON) AS SOLUOTMUON FROM #PhieuMuonTemp1 AS pmt1
		INNER JOIN dbo.SACH AS s
		ON s.MASACH = pmt1.MASACH
		INNER JOIN dbo.DAUSACH AS ds
		ON ds.ISBN = s.ISBN	
		GROUP BY ds.ISBN, ds.TENSACH
END

CREATE VIEW ViewTemp1 
AS 
SELECT ctpm.MAPM, pm.MADOCGIA, pm.NGAYMUON, ctpm.MASACH, (DATEDIFF(DAY, pm.NGAYMUON, ctpm.NGAYTRA) - 7) AS SONGAYQUAHAN 
FROM dbo.CT_PHIEUMUON AS ctpm
INNER JOIN dbo.PHIEUMUON AS pm
ON pm.MAPM = ctpm.MAPM
WHERE ctpm.TRASACH = 1
GO
CREATE VIEW ViewTemp2
AS 
SELECT ctpm.MAPM, pm.MADOCGIA, pm.NGAYMUON, ctpm.MASACH, (DATEDIFF(DAY, pm.NGAYMUON, GETDATE()) - 7) AS SONGAYQUAHAN 
FROM dbo.CT_PHIEUMUON AS ctpm
INNER JOIN dbo.PHIEUMUON AS pm
ON pm.MAPM = ctpm.MAPM
WHERE ctpm.TRASACH = 0
GO 
CREATE VIEW ViewTemp3
AS 
SELECT MAPM, MADOCGIA, NGAYMUON, MASACH, SONGAYQUAHAN FROM dbo.ViewTemp1
UNION ALL
SELECT MAPM, MADOCGIA, NGAYMUON, MASACH, SONGAYQUAHAN FROM dbo.ViewTemp2
GO
CREATE PROC [dbo].[SP_DANHSACHQUAHAN]
AS
BEGIN
	SELECT v.MADOCGIA, dg.HO+' '+dg.TEN AS HOTEN, s.MASACH, ds.TENSACH, v.NGAYMUON, v.SONGAYQUAHAN
	FROM dbo.ViewTemp3 AS v
	INNER JOIN dbo.DOCGIA AS dg
	ON dg.MADOCGIA = v.MADOCGIA
	INNER JOIN dbo.SACH AS s
	ON s.MASACH = v.MASACH
	INNER JOIN dbo.DAUSACH AS ds
	ON ds.ISBN = s.ISBN
	WHERE v.SONGAYQUAHAN > 0
	ORDER BY v.SONGAYQUAHAN DESC
END

Quan hệ giữa sách vs CT_PM Mượn thì update stt Sâch true
CT_PM không getdate()
Ràng buộc CT_PM COUNT(MAPM && TINHTRANGTRASACH = False) <=3
Ràng buộc ví dụ PM mượn cuốn đó 1 chưa trả thì sách phải 1
